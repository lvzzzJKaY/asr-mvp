<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>原音 | 在线语音复述</title>
  <style>
    :root {
      --bg-a: #f3f8ff;
      --bg-b: #e7f2ff;
      --ink: #0d1b2a;
      --muted: #5b6c84;
      --line: #d8e3f0;
      --card: rgba(255, 255, 255, 0.9);
      --brand: #1167ff;
      --brand-2: #2a8dff;
      --accent: #ff7b3d;
      --ok: #198754;
      --warn: #c46900;
      --danger: #c73b4b;
      --shadow: 0 14px 36px rgba(17, 46, 91, 0.12);
      --radius: 18px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      color: var(--ink);
      font-family: "SF Pro Display", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background:
        radial-gradient(900px 320px at -10% -20%, rgba(17, 103, 255, 0.18), transparent 72%),
        radial-gradient(760px 320px at 120% -10%, rgba(255, 123, 61, 0.16), transparent 70%),
        linear-gradient(140deg, var(--bg-a), var(--bg-b));
      padding: 20px 16px 28px;
    }

    .app {
      max-width: 980px;
      margin: 0 auto;
      display: grid;
      gap: 14px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
      padding: 16px;
    }

    .hero {
      padding: 20px;
      background: linear-gradient(140deg, rgba(255, 255, 255, 0.94), rgba(247, 252, 255, 0.88));
    }

    h1 {
      margin: 0;
      font-size: clamp(28px, 4.4vw, 46px);
      letter-spacing: 0.3px;
      line-height: 1.1;
    }

    .subtitle {
      margin: 10px 0 0;
      color: var(--muted);
      font-size: 14px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    @media (max-width: 760px) {
      .grid { grid-template-columns: 1fr; }
    }

    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 5px;
    }

    input, textarea {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      color: var(--ink);
      padding: 11px 12px;
      font-size: 14px;
      outline: none;
      transition: box-shadow 0.14s ease, border-color 0.14s ease;
    }

    textarea {
      min-height: 210px;
      resize: vertical;
      font-size: 18px;
      line-height: 1.6;
    }

    input:focus, textarea:focus {
      border-color: rgba(17, 103, 255, 0.55);
      box-shadow: 0 0 0 4px rgba(17, 103, 255, 0.12);
    }

    .status {
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
    }

    .status.ok { color: var(--ok); }
    .status.bad { color: var(--danger); }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 11px 16px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      color: #fff;
      background: linear-gradient(115deg, var(--brand), var(--brand-2));
      transition: transform 0.12s ease, filter 0.12s ease;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      filter: brightness(1.03);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    button.secondary {
      color: var(--ink);
      background: #f2f6fc;
      border: 1px solid var(--line);
      font-weight: 600;
    }

    button.accent {
      background: linear-gradient(120deg, var(--accent), #ff9e67);
    }

    .hint {
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
    }

    .banner {
      border-radius: 12px;
      padding: 10px 12px;
      margin-top: 10px;
      font-size: 13px;
      display: none;
    }

    .banner.ok {
      display: block;
      color: #0a5a35;
      background: #e6f8ef;
      border: 1px solid #b9e8d0;
    }

    .banner.warn {
      display: block;
      color: #7a4500;
      background: #fff4df;
      border: 1px solid #ffd79a;
    }

    .banner.bad {
      display: block;
      color: #7d1c2b;
      background: #ffe9ee;
      border: 1px solid #ffc4cf;
    }

    .candidate-wrap {
      margin-top: 12px;
      display: grid;
      gap: 8px;
      max-height: 220px;
      overflow: auto;
    }

    .candidate {
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 9px 10px;
      display: flex;
      gap: 8px;
      align-items: flex-start;
    }

    .candidate input {
      width: auto;
      margin-top: 3px;
    }

    audio {
      width: 100%;
      margin-top: 12px;
    }

    details {
      margin-top: 12px;
      border-top: 1px dashed var(--line);
      padding-top: 10px;
    }

    summary {
      cursor: pointer;
      color: var(--muted);
      font-size: 13px;
      user-select: none;
    }

    pre {
      margin: 8px 0 0;
      border-radius: 10px;
      background: #0f1f34;
      color: #d0e3ff;
      font-size: 12px;
      padding: 10px;
      max-height: 230px;
      overflow: auto;
    }
  </style>
</head>
<body>
  <main class="app">
    <section class="card hero">
      <h1>原音</h1>
      <p class="subtitle">一键语音输入，一键复述输出。高审美、简洁、可直接给真实用户使用。</p>
    </section>

    <section class="card">
      <div id="cfgStatus" class="status">正在读取服务状态...</div>
      <details>
        <summary>高级设置（管理员）</summary>
        <div class="grid" style="margin-top:10px;">
          <div>
            <label for="apiBase">API Base URL</label>
            <input id="apiBase" value="" />
          </div>
          <div>
            <label for="profileId">Profile ID</label>
            <input id="profileId" value="guest" />
          </div>
        </div>
      </details>
    </section>

    <section class="card">
      <label for="audioFile">上传音频（备选入口）</label>
      <input id="audioFile" type="file" accept="audio/*" />

      <div class="actions">
        <button id="btnMicPrimary" class="accent">开始说话</button>
        <button id="btnFilePrimary">上传音频极速复述</button>
        <button id="btnWarmup" class="secondary">首次调用预热</button>
      </div>

      <div class="hint">主流程：先点“开始说话”，说完后再点一次“结束并生成复述”。默认开箱即用，无需手动配置。</div>
      <div id="notice" class="banner"></div>

      <label for="recognizedText" style="margin-top:12px;">识别结果</label>
      <textarea id="recognizedText" readonly placeholder="识别文本会显示在这里"></textarea>

      <div class="actions">
        <button id="btnConfirm" class="secondary" disabled>确认当前候选</button>
      </div>

      <div id="candidateList" class="candidate-wrap"></div>
      <audio id="speechPlayer" controls></audio>

      <details>
        <summary>调试日志（高级）</summary>
        <pre id="logOut"></pre>
      </details>
    </section>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);

    const state = {
      mediaRecorder: null,
      chunks: [],
      recordedBlob: null,
      micRecording: false,
      recognizedText: "",
      selectedCandidate: "",
      ttsAudioUrl: "",
    };

    function apiBase() {
      return $("apiBase").value.trim().replace(/\/+$/, "");
    }

    function profileId() {
      return $("profileId").value.trim();
    }

    function initVisitorDefaults() {
      const apiInput = $("apiBase");
      if (!apiInput.value.trim()) {
        const isLocalPreview = window.location.protocol === "file:";
        apiInput.value = isLocalPreview ? "http://127.0.0.1:8000" : window.location.origin;
      }
      if (!$("profileId").value.trim()) {
        $("profileId").value = "guest";
      }
    }

    function log(obj) {
      $("logOut").textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    }

    function showNotice(type, text) {
      const n = $("notice");
      n.className = `banner ${type}`;
      n.textContent = text;
    }

    function clearNotice() {
      const n = $("notice");
      n.className = "banner";
      n.textContent = "";
    }

    function friendlyError(raw) {
      const msg = String(raw || "");
      if (msg.includes("can_not_use_instant_voice_cloning")) {
        return "当前 ElevenLabs 套餐不支持即时克隆。系统可自动降级为普通复述，请继续使用。";
      }
      if (msg.includes("quota") || msg.includes("429")) {
        return "API 额度不足（429）。请检查 OpenAI 账单与限额。";
      }
      if (msg.includes("Connection reset") || msg.includes("network") || msg.includes("网络错误")) {
        return "网络连接不稳定，请稍后重试。";
      }
      return msg;
    }

    function setBusy(busy) {
      $("btnFilePrimary").disabled = busy;
      $("btnMicPrimary").disabled = busy && !state.micRecording;
      $("btnWarmup").disabled = busy;
    }

    function setMicButtonLabel() {
      $("btnMicPrimary").textContent = state.micRecording ? "结束并生成复述" : "开始说话";
    }

    async function playBase64Audio(base64Text, mimeType = "audio/mpeg") {
      const binary = atob(base64Text);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i += 1) bytes[i] = binary.charCodeAt(i);
      const blob = new Blob([bytes], { type: mimeType });
      if (state.ttsAudioUrl) URL.revokeObjectURL(state.ttsAudioUrl);
      state.ttsAudioUrl = URL.createObjectURL(blob);
      const player = $("speechPlayer");
      player.src = state.ttsAudioUrl;
      await player.play();
    }

    function renderCandidates(candidates = []) {
      const root = $("candidateList");
      root.innerHTML = "";
      if (!candidates.length) {
        $("btnConfirm").disabled = true;
        return;
      }
      candidates.forEach((text, idx) => {
        const wrap = document.createElement("label");
        wrap.className = "candidate";
        const radio = document.createElement("input");
        radio.type = "radio";
        radio.name = "candidate";
        radio.value = text;
        if (idx === 0) {
          radio.checked = true;
          state.selectedCandidate = text;
        }
        radio.addEventListener("change", () => {
          state.selectedCandidate = radio.value;
        });
        const content = document.createElement("div");
        content.textContent = text;
        wrap.appendChild(radio);
        wrap.appendChild(content);
        root.appendChild(wrap);
      });
      $("btnConfirm").disabled = false;
    }

    function applyAsrResult(body) {
      state.recognizedText = body.recognized_text || "";
      $("recognizedText").value = state.recognizedText;
      renderCandidates(body.candidates || []);
    }

    async function loadConfig() {
      try {
        const res = await fetch(`${apiBase()}/config`);
        const cfg = await res.json();
        const ready = cfg.online_ready || {};
        const ok = ready.openai || ready.baidu || ready.elevenlabs;
        $("cfgStatus").className = `status ${ok ? "ok" : "bad"}`;
        $("cfgStatus").textContent = ok
          ? `服务可用：Baidu=${!!ready.baidu}，OpenAI=${!!ready.openai}，ElevenLabs=${!!ready.elevenlabs}`
          : "服务配置未完成：请设置 BAIDU_API_KEY / BAIDU_SECRET_KEY 或 OPENAI_API_KEY（以及可选 ELEVENLABS_API_KEY）";
        if (cfg.elevenlabs_clone_status === "disabled_cached" && cfg.elevenlabs_clone_note) {
          showNotice("warn", `已启用极速模式：${cfg.elevenlabs_clone_note}`);
        }
      } catch (e) {
        $("cfgStatus").className = "status bad";
        $("cfgStatus").textContent = `配置读取失败：${e.message}`;
      }
    }

    async function runOneClickWithFile(file) {
      if (!file) {
        alert("请先选择音频文件，或使用麦克风按钮。");
        return;
      }
      clearNotice();
      setBusy(true);
      $("recognizedText").value = "极速处理中：识别 -> 复述...";

      const form = new FormData();
      form.append("profile_id", profileId());
      form.append("file", file, file.name || "audio.webm");
      form.append("asr_provider", "auto");
      form.append("tts_provider", "auto");
      form.append("allow_fallback", "true");
      form.append("topk", "1");

      try {
        const res = await fetch(`${apiBase()}/transcribe-clone-speak`, { method: "POST", body: form });
        const txt = await res.text();
        let body = txt;
        try { body = JSON.parse(txt); } catch (_) {}

        if (!res.ok) {
          log(body);
          throw new Error(`HTTP ${res.status}: ${typeof body === "string" ? body : JSON.stringify(body)}`);
        }

        log(body);
        applyAsrResult(body);
        const tm = body.timing_ms || {};
        const timingNote = tm.total
          ? `（总耗时 ${tm.total}ms：识别 ${tm.asr ?? "-"}ms / 克隆 ${tm.clone ?? "-"}ms / 复述 ${tm.tts ?? "-"}ms）`
          : "";
        const providerNote = body.asr_provider_used ? `识别通道：${String(body.asr_provider_used).toUpperCase()}。` : "";
        if (body.note) {
          showNotice("warn", `${providerNote}${body.note}${timingNote}`);
        } else if (body.mode === "cloned_elevenlabs") {
          showNotice("ok", `${providerNote}已完成音色克隆并复述，正在播放。${timingNote}`);
        } else {
          showNotice("ok", `${providerNote}复述已生成，正在播放。${timingNote}`);
        }

        if (body.speech_base64) {
          await playBase64Audio(body.speech_base64, body.speech_mime || "audio/mpeg");
        }
      } catch (e) {
        showNotice("bad", friendlyError(e.message));
        throw e;
      } finally {
        setBusy(false);
      }
    }

    async function startRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      state.chunks = [];
      state.recordedBlob = null;
      state.mediaRecorder = new MediaRecorder(stream);
      state.mediaRecorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) state.chunks.push(e.data);
      };
      state.mediaRecorder.start();
    }

    async function stopRecordingToBlob() {
      if (!state.mediaRecorder) {
        throw new Error("当前没有进行中的录音。");
      }
      const rec = state.mediaRecorder;
      return new Promise((resolve, reject) => {
        rec.onstop = () => {
          try {
            state.recordedBlob = new Blob(state.chunks, { type: rec.mimeType || "audio/webm" });
            resolve(state.recordedBlob);
          } catch (err) {
            reject(err);
          }
        };
        rec.onerror = (e) => reject(new Error(e.error?.message || "录音失败"));
        rec.stop();
        rec.stream.getTracks().forEach((t) => t.stop());
      });
    }

    async function toggleMicFlow() {
      if (!state.micRecording) {
        await startRecording();
        state.micRecording = true;
        setMicButtonLabel();
        showNotice("ok", "录音中，请说话。说完后再次点击按钮结束。");
        return;
      }

      setBusy(true);
      try {
        const blob = await stopRecordingToBlob();
        const file = new File([blob], "yuanyin-mic.webm", { type: blob.type || "audio/webm" });
        state.micRecording = false;
        setMicButtonLabel();
        await runOneClickWithFile(file);
      } finally {
        state.micRecording = false;
        setMicButtonLabel();
        setBusy(false);
      }
    }

    async function confirmCandidate() {
      const recognized = state.recognizedText;
      const chosen = state.selectedCandidate || recognized;
      if (!recognized || !chosen) {
        alert("请先完成一次识别。");
        return;
      }
      const res = await fetch(`${apiBase()}/confirm`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ profile_id: profileId(), recognized, chosen }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(JSON.stringify(data));
      showNotice("ok", "候选已确认并写入个性化记录。");
      log(data);
    }

    async function runWarmup() {
      clearNotice();
      setBusy(true);
      showNotice("ok", "预热中：正在建立与线上语音服务的连接...");
      try {
        const res = await fetch(`${apiBase()}/warmup`, { method: "POST" });
        const txt = await res.text();
        let body = txt;
        try { body = JSON.parse(txt); } catch (_) {}
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${typeof body === "string" ? body : JSON.stringify(body)}`);
        }
        log(body);
        const op = body?.providers?.openai || {};
        const bd = body?.providers?.baidu || {};
        const el = body?.providers?.elevenlabs || {};
        showNotice(
          "ok",
          `预热完成：Baidu ${bd.ok ? "OK" : "未就绪"} (${bd.latency_ms ?? "-"}ms)，OpenAI ${op.ok ? "OK" : "未就绪"} (${op.latency_ms ?? "-"}ms)，ElevenLabs ${el.ok ? "OK" : "未就绪"} (${el.latency_ms ?? "-"}ms)。`
        );
      } catch (e) {
        showNotice("bad", `预热失败：${friendlyError(e.message)}`);
      } finally {
        setBusy(false);
      }
    }

    $("btnMicPrimary").addEventListener("click", () => {
      toggleMicFlow().catch((e) => {
        state.micRecording = false;
        setMicButtonLabel();
        showNotice("bad", friendlyError(e.message));
      });
    });

    $("btnFilePrimary").addEventListener("click", () => {
      const file = $("audioFile").files?.[0];
      runOneClickWithFile(file).catch((e) => showNotice("bad", friendlyError(e.message)));
    });

    $("btnWarmup").addEventListener("click", () => {
      runWarmup().catch((e) => showNotice("bad", friendlyError(e.message)));
    });

    $("btnConfirm").addEventListener("click", () => {
      confirmCandidate().catch((e) => showNotice("bad", friendlyError(e.message)));
    });

    initVisitorDefaults();
    setMicButtonLabel();
    loadConfig();
  </script>
</body>
</html>
